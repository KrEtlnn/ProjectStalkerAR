<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
       <meta charset="utf-8" />
       <title>S.T.A.L.K.E.R. AR</title>
        <link rel="stylesheet" href="stylesheets/style.css" />
        <script src="../datasync-js-master/build/cloud-data-sync-api.js" type="text/javascript"></script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDR1bbsuzqtUoTOixGdrRqbv6dBZj8ceDs&callback=initMap"></script>
        <script src="../gmaps.js" type="text/javascript"></script>
    </head>
    <body>
        <ul id="menu">
            <li class="li" id="hp">HP:</li>
            <li class="li"></li>
            <li class="li"></li>
        </ul>
        <div id="map"></div>
        <script>
            var icon = {
                bandos: '/photos/bandos.png',
                sidor: '/photos/sidor.png',
                flesh: '/photos/flesh.png',
                dog: '/photos/dog.png',
                me: '/photos/me.png'
            };

            var player = {
                hp: 100
            };

            var bandoses = [];
            var fleshes = [];
            var map;
            var bandosId = 0;
            var fleshId = 0;
            function initMap() {
                var mapOptions = {
                    center: { lat: 56.784408, lng: 35.956532 },
                    zoom: 18,
                    zoomControl: false,
                    streetViewControl: false
                }
                map = new google.maps.Map(document.getElementById('map'), mapOptions);

                var sidor = new google.maps.Marker({
                    position: { lat: 56.785167, lng: 35.958151 },
                    map: map,
                    label: 'Сидрыч',
                    title: 'Сидрыч',
                    icon: icon.sidor,
                });
                var sidorCircle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FFF000',
                    fillOpacity: 0.35,
                    map: map,
                    center: sidor.getPosition(),
                    radius: 15
                });

                var myMarker = new google.maps.Marker({
                    position: { lat: 1, lng: 1 },
                    label: 'Я',
                    title: 'Я',
                    map: map,
                    icon: icon.me
                });
                var myCircle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FFF000',
                    fillOpacity: 0.35,
                    map: map,
                    radius: 3
                });

                function spawnBandos() {
                    var bandosPosition = {
                        lat: function () {
                            var i = Math.round(Math.random() * 1);
                            switch (i) {
                                case 0: var latit = (myMarker.getPosition().lat() + Math.round(Math.random() * 350) / 1000000); break;
                                case 1: var latit = (myMarker.getPosition().lat() - Math.round(Math.random() * 350) / 1000000); break;
                            };
                            return latit;
                        },
                        lng: function () {
                            var i = Math.round(Math.random() * 1);
                            switch (i) {
                                case 0: var longit = (myMarker.getPosition().lng() + Math.round(Math.random() * 700) / 1000000); break;
                                case 1: var longit = (myMarker.getPosition().lng() - Math.round(Math.random() * 700) / 1000000); break;
                            };
                            return longit;
                        }
                    };
                    var bandosLocation = new google.maps.LatLng(bandosPosition.lat(), bandosPosition.lng());
                    if (google.maps.geometry.spherical.computeDistanceBetween(bandosLocation, myMarker.getPosition()) < 40 && google.maps.geometry.spherical.computeDistanceBetween(bandosLocation, myMarker.getPosition()) > 30) {
                        var x = Math.round(Math.random() * 40)
                        if (x == 20) {
                            if (bandosId < 10) {
                                var name = "bandos" + bandosId
                                var name = new google.maps.Marker({
                                    position: bandosLocation,
                                    map: map,
                                    label: 'Бандит',
                                    title: 'Бандит',
                                    icon: icon.bandos,
                                });
                                bandoses.push(name);
                                console.log('Бандит' + bandosId + ' spawned at ' + bandosLocation);
                                bandosId++;
                            };
                        };
                    } else {
                        spawnBandos();
                    };
                };

                setInterval(spawnBandos, 5000);

                function spawnFlesh() {
                    var fleshPosition = {
                        lat: function () {
                            var i = Math.round(Math.random() * 1);
                            switch (i) {
                                case 0: var latit = (myMarker.getPosition().lat() + Math.round(Math.random() * 350) / 1000000); break;
                                case 1: var latit = (myMarker.getPosition().lat() - Math.round(Math.random() * 350) / 1000000); break;
                            };
                            return latit;
                        },
                        lng: function () {
                            var i = Math.round(Math.random() * 1);
                            switch (i) {
                                case 0: var longit = (myMarker.getPosition().lng() + Math.round(Math.random() * 700) / 1000000); break;
                                case 1: var longit = (myMarker.getPosition().lng() - Math.round(Math.random() * 700) / 1000000); break;
                            };
                            return longit;
                        }
                    };
                    var fleshLocation = new google.maps.LatLng(fleshPosition.lat(), fleshPosition.lng());
                    if (google.maps.geometry.spherical.computeDistanceBetween(fleshLocation, myMarker.getPosition()) < 40 && google.maps.geometry.spherical.computeDistanceBetween(fleshLocation, myMarker.getPosition()) > 30) {
                        var x = Math.round(Math.random() * 30)
                        if (x == 15) {
                            if (fleshId < 10) {
                                var name = "flesh" + fleshId
                                var name = new google.maps.Marker({
                                    position: fleshLocation,
                                    map: map,
                                    label: 'Плоть',
                                    title: 'Плоть',
                                    icon: icon.flesh,
                                });
                                fleshes.push(name);
                                console.log('Плоть' + fleshId + ' spawned at ' + fleshLocation);
                                fleshId++;
                            };
                        };
                    } else {
                        spawnFlesh();
                    };
                };
                
                setTimeout(function () { setInterval(spawnFlesh, 5000) }, 2500);

                function changeMyPos(location) {
                    myMarker.setPosition(location);
                    myCircle.setCenter(location);
                }

                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(geolocationSuccess, geolocationFailure, { enableHighAccuracy: true, timeout: 27000 });

                } else {
                    alert('Чёт беда прям. Ты попробуй другой браузер запусти')
                };

                function geolocationSuccess(position) {
                    document.getElementById('hp').innerHTML = 'HP: ' + player.hp;
                    if(player.hp <= 0){window.location = "/gameover"}
                    // Преобразуем местоположение в объект LatLng
                    var location = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                    // Отображаем эту точку на карте
                    console.log('geolocation updated successfully');
                    map.setCenter(location);
                    changeMyPos(location);

                    bandoses.forEach(function (item, i) {
                        //Ищем далёких бандитов и скрываем их
                        if (google.maps.geometry.spherical.computeDistanceBetween(bandoses[i].getPosition(), myMarker.getPosition()) > 40) {
                            if (bandoses[i].getMap() == map) {
                                bandoses[i].setMap(null);
                                console.log('marker ' + bandoses[i].getTitle() + i + ' was hidden because he is far from you');
                            };
                        };
                        //Ищем очень далёких бандитов и удаляем их
                        if (google.maps.geometry.spherical.computeDistanceBetween(bandoses[i].getPosition(), myMarker.getPosition()) > 100) {
                            bandoses[i].setMap(null);
                            bandoses.splice(i, 1);
                            bandosId--;
                            console.log('marker ' + bandoses[i].getTitle() + i + ' was deleted because he is very far from you');
                        };
                        //Ищем близких бандитов и показываем их
                        if (google.maps.geometry.spherical.computeDistanceBetween(bandoses[i].getPosition(), myMarker.getPosition()) < 40) {
                            if (bandoses[i].getMap() != map) {
                                bandoses[i].setMap(map);
                                console.log('marker ' + bandoses[i].getTitle() + i + ' is shown because he is not far from you');
                            };
                        };
                        //Вибрируем, если рядом бандос
                        if (google.maps.geometry.spherical.computeDistanceBetween(bandoses[i].getPosition(), myMarker.getPosition()) < 15) {
                            window.navigator.vibrate([100, 50, 100, 50, 100]);
                        };
                    });

                    fleshes.forEach(function (item, i) {
                        //Получаем урон от плоти
                        var damage = setTimeout(function () {
                            if (google.maps.geometry.spherical.computeDistanceBetween(fleshes[i].getPosition(), myMarker.getPosition()) < 5) {
                                window.navigator.vibrate(200);
                                player.hp -= 5;
                                console.log('you got 5 damage from' + fleshes[i].getTitle() + i + '\n HP:' + player.hp);
                                document.getElementById('hp').innerHTML = "HP: " + player.hp;
                                if (player.hp <= 0) { window.location = "/gameover" }
                            };
                        }, 10000);
                        
                        //Ищем далёкую плоть и скрываем её
                        if (google.maps.geometry.spherical.computeDistanceBetween(fleshes[i].getPosition(), myMarker.getPosition()) > 40) {
                            if (fleshes[i].getMap() == map) {
                                fleshes[i].setMap(null);
                                console.log('marker ' + fleshes[i].getTitle() + i + ' was hidden because he is far from you');
                            };
                        };
                        //Ищем очень далёкую плоть и удаляем её
                        if (google.maps.geometry.spherical.computeDistanceBetween(fleshes[i].getPosition(), myMarker.getPosition()) > 100) {
                            fleshes[i].setMap(null);
                            fleshes.splice(i, 1);
                            fleshId--;
                            console.log('marker ' + fleshes[i].getTitle() + i + ' was deleted because he is very far from you');
                        };
                        //Ищем близкую плоть и показываем её
                        if (google.maps.geometry.spherical.computeDistanceBetween(fleshes[i].getPosition(), myMarker.getPosition()) < 40) {
                            if (fleshes[i].getMap() != map) {
                                fleshes[i].setMap(map);
                                console.log('marker ' + fleshes[i].getTitle() + i + ' is shown because he is not far from you');
                            };
                        };
                        //Вибрируем и орём, если рядом плоть
                        if (google.maps.geometry.spherical.computeDistanceBetween(fleshes[i].getPosition(), myMarker.getPosition()) < 15) {
                            window.navigator.vibrate([100, 50, 100, 50, 100]);
                            var fleshAudio = new Audio('flesh_idle.mp3');
                            fleshAudio.play();
                        };
                    });
                };

                function geolocationFailure(errorCode) {
                    map.setCenter({ lat: 1, lng: 1 });
                    var msg = "";
                    switch (errorCode) {
                        case 1: msg = "Нет разрешения";
                            break;
                        case 2: msg = "Техническая ошибка";
                            break;
                        case 3: msg = "Превышено время ожидания";
                            break;
                        default: msg = "Что то случилось не так";
                    };
                    alert(msg);
                };

                function bandosWalk() {
                    bandoses.forEach(function (item,i) {
                        var x = Math.round(Math.random() * 2);
                        var y = Math.round(Math.random() * 2);
                        switch (x) {
                            case 0: {
                                var latit = bandoses[i].getPosition().lat() + 0.000005;
                                break;
                            };
                            case 1: {
                                var latit = bandoses[i].getPosition().lat() - 0.000005;
                                break;
                            };
                            case 2: {
                                var latit = bandoses[i].getPosition().lat();
                                break;
                            };
                        };
                        switch (y) {
                            case 0: {
                                var longit = bandoses[i].getPosition().lng() + 0.000005;
                                break;
                            };
                            case 1: {
                                var longit = bandoses[i].getPosition().lng() - 0.000005;
                                break;
                            };
                            case 2: {
                                var longit = bandoses[i].getPosition().lng();
                                break;
                            };
                        };
                        bandoses[i].setPosition({ lat: latit, lng: longit });
                    });
                };

                setInterval(bandosWalk, 500);

                function fleshWalk() {
                    fleshes.forEach(function (item, i) {
                        var x = Math.round(Math.random() * 2);
                        var y = Math.round(Math.random() * 2);
                        switch (x) {
                            case 0: {
                                var latit = fleshes[i].getPosition().lat() + 0.00001;
                                break;
                            };
                            case 1: {
                                var latit = fleshes[i].getPosition().lat() - 0.00001;
                                break;
                            };
                            case 2: {
                                var latit = fleshes[i].getPosition().lat();
                                break;
                            };
                        };
                        switch (y) {
                            case 0: {
                                var longit = fleshes[i].getPosition().lng() + 0.00001;
                                break;
                            };
                            case 1: {
                                var longit = fleshes[i].getPosition().lng() - 0.00001;
                                break;
                            };
                            case 2: {
                                var longit = fleshes[i].getPosition().lng();
                                break;
                            };
                        };
                        fleshes[i].setPosition({ lat: latit, lng: longit });
                    });
                };

                setInterval(fleshWalk, 500);

            };
        </script>
        <script src="javascripts/map.js"></script>
    </body>
</html>