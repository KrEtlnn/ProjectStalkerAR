<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
       <meta charset="utf-8" />
       <title>S.T.A.L.K.E.R. AR</title>
        <link rel="stylesheet" href="stylesheets/style.css" />
        <script src="../datasync-js-master/build/cloud-data-sync-api.js" type="text/javascript"></script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDR1bbsuzqtUoTOixGdrRqbv6dBZj8ceDs&callback=initMap"></script>
        <script src="../gmaps.js" type="text/javascript"></script>
    </head>
    <body>
        <ul id="menu">
            <li class="li">1</li>
            <li class="li">2</li>
            <li class="li">3</li>
        </ul>
        <div id="map"></div>
        <script>
            var icon = {
                bandos: '/photos/bandos.png',
                sidor: '/photos/sidor.png',
                dog: '/photos/dog.png',
                me: '/photos/me.png'
            };
            var markers = [];
            var map;
            function initMap() {
                var mapOptions = {
                    center: { lat: 56.784408, lng: 35.956532 },
                    zoom: 18,
                    zoomControl: false,
                    streetViewControl: false
                }
                map = new google.maps.Map(document.getElementById('map'), mapOptions);

                var sidor = new google.maps.Marker({
                    position: { lat: 56.785167, lng: 35.958151 },
                    map: map,
                    label: 'Сидрыч',
                    title: 'Сидрыч',
                    icon: icon.sidor,
                });
                var sidorCircle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FFF000',
                    fillOpacity: 0.35,
                    map: map,
                    center: sidor.getPosition(),
                    radius: 15
                });

                var myMarker = new google.maps.Marker({
                    position: { lat: 1, lng: 1 },
                    label: 'Я',
                    title: 'Я',
                    map: map,
                    icon: icon.me
                });
                var myCircle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FFF000',
                    fillOpacity: 0.35,
                    map: map,
                    radius: 3
                });

                var bandosId = 0;

                function spawnBandos() {
                    var bandosPosition = {
                        lat: function () {
                            var i = Math.round(Math.random() * 1);
                            switch (i) {
                                case 0: var latit = (myMarker.getPosition().lat() + Math.round(Math.random() * 350) / 1000000); break;
                                case 1: var latit = (myMarker.getPosition().lat() - Math.round(Math.random() * 350) / 1000000); break;
                            };
                            return latit;
                        },
                        lng: function () {
                            var i = Math.round(Math.random() * 1);
                            switch (i) {
                                case 0: var longit = (myMarker.getPosition().lng() + Math.round(Math.random() * 700) / 1000000); break;
                                case 1: var longit = (myMarker.getPosition().lng() - Math.round(Math.random() * 700) / 1000000); break;
                            };
                            return longit;
                        }
                    };
                    var bandosLocation = new google.maps.LatLng(bandosPosition.lat(), bandosPosition.lng());
                    var x = Math.round(Math.random() * 0)
                    if (x == 0) {
                        if (bandosId < 10) {
                            var name = "bandos" + bandosId
                            var name = new google.maps.Marker({
                                position: bandosLocation,
                                map: map,
                                label: 'Бандит',
                                title: 'Бандит',
                                icon: icon.bandos,
                            });
                            markers.push(name);
                            console.log('bandos spawned ' + bandosLocation);
                            bandosId++;
                        }
                    };
                };

                setInterval(spawnBandos, 1000);

                function changeMyPos(location) {
                    myMarker.setPosition(location);
                    myCircle.setCenter(location);
                }

                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(geolocationSuccess, geolocationFailure, { enableHighAccuracy: true });

                } else {
                    alert('Чёт беда прям. Ты попробуй другой браузер запусти')
                };

                function geolocationSuccess(position) {
                    // Преобразуем местоположение в объект LatLng
                    var location = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                    // Отображаем эту точку на карте
                    console.log('geolocation success');
                    map.setCenter(location);
                    changeMyPos(location);

                    markers.forEach(function (item, i) {
                        //Ищем далёкие маркеры и скрываем их
                        if (google.maps.geometry.spherical.computeDistanceBetween(markers[i].getPosition(), myMarker.getPosition()) > 40) {
                            if (markers[i].getMap() == map) {
                                markers[i].setMap(null);
                                console.log('marker' + item + i + 'was hidden because he is far from you');
                            };
                        };
                        //Ищем очень далёкие маркеры и удаляем их
                        if (google.maps.geometry.spherical.computeDistanceBetween(markers[i].getPosition(), myMarker.getPosition()) > 100) {
                            markers[i].setMap(null);
                            markers.splice(i, 1);
                            bandosId--;
                            console.log('marker' + item[i] + 'was deleted because he is very far from you');
                        };
                        //Ищем близкие маркеры и показываем их
                        if (google.maps.geometry.spherical.computeDistanceBetween(markers[i].getPosition(), myMarker.getPosition()) < 40) {
                            if (markers[i].getMap() != map) {
                                markers[i].setMap(map);
                                console.log('marker' + item[i] + 'is shown because he is not far from you');
                            };
                        };
                    });
                };

                function geolocationFailure(errorCode) {
                    map.setCenter({ lat: 1, lng: 1 });
                    var msg = "";
                    switch (errorCode) {
                        case 1: msg = "Нет разрешения";
                            break;
                        case 2: msg = "Техническая ошибка";
                            break;
                        case 3: msg = "Превышено время ожидания";
                            break;
                        default: msg = "Что то случилось не так";
                    };
                    alert(msg);
                };
            };
        </script>
        <script src="javascripts/map.js"></script>
    </body>
</html>